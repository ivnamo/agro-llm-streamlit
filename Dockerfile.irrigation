# Dockerfile.irrigation
FROM python:3.11-slim

# Evitar bytecode y buffering
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Instalar dependencias
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiar TODO el repositorio
COPY . .

# Puerto standard
ENV PORT=8080

# ---------------------------------------------------------
# SOLUCIÓN: Añadir /app al PYTHONPATH
# Esto permite que los imports tipo "from cloud_run..." funcionen
# ---------------------------------------------------------
ENV PYTHONPATH="/app"

# Forzamos a que este contenedor lea SOLO la carpeta de manuales técnicos
ENV RAG_PREFIX="rag/manuales"

# Comando de arranque con functions-framework
CMD ["functions-framework", "--target=run_irrigation_agent", "--port=8080", "--source=cloud_run/irrigation_agent/main.py"]
